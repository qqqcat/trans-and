# 实时翻译项目事故复盘与对话全流程记录

## 1. 事故概要
- **时间**：2025-10-27（美东时间）
- **影响**：Android 原生端与 Flutter 客户端近期改动全部被回滚，`AGENTS.md` 等关键配置丢失，导致已有修复、日志及截图均失效。
- **根因**：为恢复被误删的 `all.log`、`alv.log`，误用 git 恢复命令覆盖了工作区，撤销了尚未备份的本地修改。
- **当前状态**：多项历史问题重新出现（截图乱码、计时器显示异常、历史记录缺失、模型 404、WebRTC 崩溃等），用户计划重新构建项目。

## 2. 事件经过（关键节点）
| 阶段 | 时间线 | 现象与处理 |
| ---- | ------ | ---------- |
| A. UI 与功能缺陷 | 最初对话 | 首页计时器乱码，ASR/翻译/TTS 显示 0 ms，历史记录为空，实时语音区块冗余；提出需全语言修复并精简界面。 |
| B. Kotlin 构建失败 | `./gradlew assembleDebug` | 编译报错：局部函数误加 `private`，`HomeRoute.kt` 注解重复。要求修复后确保编译通过。 |
| C. 历史会话未持久化 | 多次真机测试 | 对话结束后历史记录依旧为空。前序模型已在 `RealtimeEventStream` 中新增 transcript 解析，但未验证全链路。 |
| D. 应用闪退 | `a.log` | 启动即崩溃，`unexpected scheme: wss` → WebRTC 会话初始化未处理自定义协议。 |
| E. 进一步日志分析 | `a.log` 最新 | `libjingle_peerconnection_so` 触发 SIGABRT，显示信令线程异常关闭，提示 WebRTC 连接未正确握手。 |
| F. Git 误操作事故 | 事故时刻 | 为恢复日志执行 git 恢复操作，导致 `AGENTS.md` 与近期所有改动丢失，历史修复进度回退到多天前。 |
| G. Flutter 端调试 | `b.log` | 调用 Azure Realtime 接口返回 404 “deployment not found”；WebRTC 连接反复关闭。 |
| H. 事故后续 | 当前 | 用户准备整体重建，要求汇总事故原因并整理整段对话问题与处理情况。 |

## 3. 根因分析
1. **操作层面**  
   - 未核实 git 命令的影响范围，直接恢复历史版本覆盖工作区。  
   - 缺乏本地快照（stash/临时分支）及增量备份，导致回滚后无法找回增量修改。
2. **流程层面**  
   - 任务链冗长但缺少阶段性提交；一旦回滚即丢失多个问题的并行修复。  
   - 缺乏事故前的操作留痕（命令、diff），复原成本高。
3. **技术侧风险**  
   - 后端实时部署配置不清晰，导致多轮 404 调用；在改动被覆盖后难以定位最新状态。  
   - WebRTC 与 UI 问题互相穿插，尚未建立可靠的回归验证脚本。

## 4. 影响评估
- **功能回退**：UI 修复、实时会话管理、历史记录持久化等反复失效。
- **时间成本**：需重新排查编译错误、日志解析、Azure 配置、Flutter/Android 双端问题。
- **信任风险**：关键配置文件被覆盖，难以保证后续操作的安全性。

## 5. 整体对话问题与处理摘要
1. **UI 多语言兼容**：计时器格式化、ASR/TTS 指标、实时语音提示区块等需统一国际化资源。  
2. **会话控制**：防止页面切换自动开启新对话，需由用户触发麦克风。  
3. **历史记录**：确认 `RealtimeEventStream` → `TranslationRepository` → 持久层的数据流，补齐保存与回放逻辑。  
4. **编译链路**：修正 Kotlin 局部函数修饰符、重复注解，保证 `assembleDebug` 可通过。  
5. **日志崩溃**：处理 `wss` scheme，完善 WebRTC SDP/ICE 流程，避免 `libjingle` SIGABRT。  
6. **Azure Realtime 404**：核对部署名称、API 版本和资源路径，必要时改用通用 `/openai/responses` 接口并增加容错。  
7. **Flutter 端性能日志**：分析 `BLASTBufferQueue` 警告、帧率跳变等渲染提示。  
8. **事故回滚**：由于 git 误操作，当前需重新整理以上问题并重建环境。

## 6. 立即行动建议
1. **操作规范**  
   - 禁止在未确认差异前使用 `git checkout --`、`reset --hard` 等覆盖式命令。  
   - 形成“修改前 `git status`、关键操作前 `git stash push`、阶段性 `git commit --all`”的最小流程。  
   - 将日志恢复改为 `cp`/`Get-Content` 等安全方式，避免动用版本库。
2. **配置管理**  
   - 关键文件（如 `AGENTS.md`、环境变量、脚本）加入备份策略，必要时同步到私有安全仓库。  
   - 引入 `.gitignore` 白名单机制，确保日志文件无需依赖 git 恢复。
3. **回归保障**  
   - 为 UI、Realtime Session、历史记录撰写最小化自动化测试或手工检查清单。  
   - 建议在 Android 与 Flutter 两端增加构建验证流水线，预防编译错误被忽略。

## 7. 后续计划（建议）
1. **环境重建**：按优先级重做 UI 修复 → 构建修复 → Realtime API 校对 → 历史记录验证。  
2. **文档化**：保留此次复盘，与团队共享操作规范和回滚应急流程。  
3. **追踪机制**：建立每日变更日志，记录命令与关键文件 diff，便于事后追责与恢复。

---
**参考日志**：`a.log`（2025-10-27 崩溃栈）、`b.log`（Flutter Realtime 404）。  
**撰写时间**：2025-10-27。
